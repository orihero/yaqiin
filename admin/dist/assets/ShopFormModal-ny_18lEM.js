import{u as ae,r as u,R as de,j as e}from"./index-BouADcV8.js";import{u as ce}from"./index.esm-A7arJavU.js";import{u as $}from"./index-DS6Sn0NB.js";import{a as ie,b as me}from"./userService-CG63Svn2.js";import{i as he}from"./shopService-CWGVHyjB.js";import{I as ue}from"./ImagePreviewModal-jtcB2eMQ.js";function pe(d,i){const s={};for(const m in i)if(i.hasOwnProperty(m)){const c=d[m],n=i[m];if(n===void 0)continue;if(n===null&&c!==null){s[m]=n;continue}typeof n=="object"&&n!==null?Array.isArray(n)?(!Array.isArray(c)||JSON.stringify(c)!==JSON.stringify(n))&&(s[m]=n):(typeof c!="object"||c===null||JSON.stringify(c)!==JSON.stringify(n))&&(c&&typeof c=="object"?s[m]={...c,...n}:s[m]=n):c!==n&&(s[m]=n)}return s}function K(d,i){const s=pe(d,i),m={};for(const c in s)if(s.hasOwnProperty(c)){const n=s[c];n!=null&&(typeof n=="object"&&!Array.isArray(n)?Object.keys(n).length>0&&(m[c]=n):m[c]=n)}return m}const Q=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];function G(){return Q.reduce((d,i)=>(d[i]={open:"09:00",close:"18:00",isOpen:!0},d),{})}function xe(d){return d?typeof d=="string"?e.jsx("div",{className:"text-red-400 text-xs",children:d}):d.errors?e.jsx("ul",{className:"text-red-400 text-xs mb-2",children:Object.entries(d.errors).map(([i,s])=>e.jsxs("li",{children:[i,": ",s.message]},i))}):d.message?e.jsx("div",{className:"text-red-400 text-xs mb-2",children:d.message}):null:null}function ye({open:d,mode:i,initialValues:s,loading:m,error:c,details:n,onClose:_,onSubmit:X}){const{t}=ae(),p=i==="edit",k={street:"",city:"",district:"",coordinates:{lat:0,lng:0}},S={phoneNumber:"",email:"",telegramUsername:""},[x,F]=u.useState(null),[g,L]=u.useState(null),[f,N]=u.useState(s?.photo||null),[b,y]=u.useState(s?.logo||null),[O,H]=u.useState(null),[M,P]=u.useState(!1),[z,C]=u.useState(!1),q=u.useRef(null),R=u.useRef(null),{register:h,handleSubmit:Y,reset:E,formState:{errors:a}}=ce({defaultValues:{name:"",ownerId:"",contactInfo:{...S,...s?.contactInfo||{}},address:{...k,...s?.address||{}},status:"active",description:"",...s}}),{data:j,isLoading:Z,error:A}=$({queryKey:["available-owners"],queryFn:me,enabled:d}),{data:U,isLoading:V,error:ee}=$({queryKey:["unassigned-groups"],queryFn:he,enabled:d}),[v,w]=u.useState(s?.operatingHours||G()),[T,J]=u.useState(null),se=o=>{const l=o.target.files?.[0];if(console.log("Photo file selected:",l),l){F(l),P(!1);const r=new FileReader;r.onload=I=>{N(I.target?.result)},r.readAsDataURL(l)}else F(null),N(null)},oe=o=>{const l=o.target.files?.[0];if(console.log("Logo file selected:",l),l){L(l),C(!1);const r=new FileReader;r.onload=I=>{y(I.target?.result)},r.readAsDataURL(l)}else L(null),y(null)},te=()=>{F(null),N(null),P(!0),q.current&&(q.current.value="")},re=()=>{L(null),y(null),C(!0),R.current&&(R.current.value="")},B=(o,l=0)=>{H({images:o,initialIndex:l})};u.useEffect(()=>{d&&i==="edit"&&s&&(console.log("Setting up edit mode with initial values:",s),console.log("Photo URL:",s.photo),console.log("Logo URL:",s.logo),E({name:s.name||"",ownerId:s.ownerId||"",contactInfo:{...S,...s.contactInfo||{}},address:{...k,...s.address||{}},status:s.status||"active",description:s.description||"",...s}),w(s.operatingHours||G()),N(s.photo||null),y(s.logo||null),P(!1),C(!1),console.log("Photo preview set to:",s.photo),console.log("Logo preview set to:",s.logo)),d&&i==="add"&&(E({name:"",ownerId:"",contactInfo:{...S},address:{...k},status:"active",description:""}),w(G()),F(null),L(null),N(null),y(null))},[d,i,s,E]),u.useEffect(()=>{p&&s?.ownerId&&j&&!j.some(o=>o._id===s.ownerId)?ie(s.ownerId).then(J):J(null)},[p,s,j]);const le=de.useMemo(()=>{let o=j?[...j]:[];return p&&s?.ownerId&&T&&!o.some(l=>l._id===s.ownerId)&&o.push(T),o},[j,p,s,T]);return d?e.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30 backdrop-blur-sm transition-all z-[9999]",style:{backdropFilter:"blur(8px)"},onClick:_}),e.jsxs("div",{className:"fixed top-0 right-0 h-full w-full max-w-xl bg-[#232b42] shadow-2xl p-8 overflow-y-auto transition-transform duration-300 transform translate-x-0 z-[99999]",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:t(p?"shops.editShop":"shops.addShop")}),c&&e.jsx("div",{className:"text-red-400 mb-2",children:c}),xe(n),e.jsxs("form",{onSubmit:Y(o=>{console.log("=== FORM SUBMISSION START ==="),console.log("Form values:",o),console.log("Photo file state at submission:",x),console.log("Logo file state at submission:",g);const l={...o,operatingHours:v,contactInfo:{...S,...s?.contactInfo||{},...o.contactInfo||{}},address:{...k,...s?.address||{},...o.address||{}}};x&&(l.photoFile=x,console.log("Photo file added to currentValues:",x.name)),g&&(l.logoFile=g,console.log("Logo file added to currentValues:",g.name)),console.log("Current values after file addition:",l);let r;if(p&&s){if(console.log("=== EDIT MODE DEBUG ==="),console.log("Photo file state:",x),console.log("Logo file state:",g),console.log("Photo preview:",f),console.log("Logo preview:",b),x||g||M||z){console.log("File uploads or removals detected - sending FormData"),r={_id:s._id,photoFile:x||void 0,logoFile:g||void 0},M&&(r.removePhoto=!0),z&&(r.removeLogo=!0);const{photoFile:I,logoFile:ne,...D}=l,W=K(s,D);r={...r,...W}}else{console.log("No file uploads - sending only changed fields");const{photoFile:I,logoFile:ne,...D}=l;r={...K(s,D)},r._id||(r._id=s._id),s.photo&&(r.photo=s.photo),s.logo&&(r.logo=s.logo)}console.log("Final submit values:",r),console.log("Submit values keys:",Object.keys(r))}else r=l;X(r)}),children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block mb-1",children:t("shops.shopName")}),e.jsx("input",{className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("name",{required:t("forms.validation.required")})}),a.name&&e.jsx("span",{className:"text-red-400 text-xs",children:a.name.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:t("shops.owner")}),Z?e.jsx("div",{className:"text-gray-400 text-xs",children:t("common.loading")}):A?e.jsx("div",{className:"text-red-400 text-xs",children:A instanceof Error?A.message:t("shops.failedToLoadOwners","Failed to load owners")}):e.jsxs("select",{className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("ownerId",{required:t("forms.validation.required")}),children:[e.jsxs("option",{value:"",disabled:!0,children:[t("common.select")," ",t("shops.owner").toLowerCase()]}),le.map(o=>e.jsxs("option",{value:o._id,children:[o.firstName||""," ",o.lastName||""," ",o.username?`(@${o.username})`:""," ",o.phoneNumber?`- ${o.phoneNumber}`:""]},o._id))]}),a.ownerId&&e.jsx("span",{className:"text-red-400 text-xs",children:a.ownerId.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:t("shops.telegramOrdersChatGroup","Telegram Orders Chat Group")}),V?e.jsx("div",{className:"text-gray-400 text-xs",children:t("common.loading")}):ee?e.jsx("div",{className:"text-red-400 text-xs",children:t("shops.failedToLoadGroups","Failed to load groups")}):e.jsxs("select",{className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("orders_chat_id"),defaultValue:s?.orders_chat_id||"",children:[e.jsxs("option",{value:"",children:[t("common.select")," ",t("common.group","group")]}),U&&U.map(o=>e.jsxs("option",{value:o.chatId,children:[o.title||o.chatId," (",o.chatId,")"]},o.chatId)),p&&s?.orders_chat_id&&!U?.some(o=>String(o.chatId)===String(s.orders_chat_id))&&e.jsxs("option",{value:s.orders_chat_id,children:[s.orders_chat_id," (",t("shops.currentlyAssigned","currently assigned"),")"]})]}),e.jsx("span",{className:"text-gray-400 text-xs",children:t("shops.telegramGroupDescription","Select the Telegram group chat for this shop's orders.")}),a.orders_chat_id&&e.jsx("span",{className:"text-red-400 text-xs",children:a.orders_chat_id.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:t("common.phone")}),e.jsx("input",{className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("contactInfo.phoneNumber",{required:t("forms.validation.required")})}),a.contactInfo?.phoneNumber&&e.jsx("span",{className:"text-red-400 text-xs",children:a.contactInfo.phoneNumber.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:t("common.email")}),e.jsx("input",{type:"email",className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("contactInfo.email")}),a.contactInfo?.email&&e.jsx("span",{className:"text-red-400 text-xs",children:a.contactInfo.email.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:t("common.telegramUsername","Telegram Username")}),e.jsx("input",{className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("contactInfo.telegramUsername")}),a.contactInfo?.telegramUsername&&e.jsx("span",{className:"text-red-400 text-xs",children:a.contactInfo.telegramUsername.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:t("users.city")}),e.jsx("input",{className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("address.city",{required:t("forms.validation.required")})}),a.address?.city&&e.jsx("span",{className:"text-red-400 text-xs",children:a.address.city.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:t("shops.street","Street")}),e.jsx("input",{className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("address.street",{required:t("forms.validation.required")})}),a.address?.street&&e.jsx("span",{className:"text-red-400 text-xs",children:a.address.street.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:t("shops.district","District")}),e.jsx("input",{className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("address.district",{required:t("forms.validation.required")})}),a.address?.district&&e.jsx("span",{className:"text-red-400 text-xs",children:a.address.district.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:t("shops.latitude","Latitude")}),e.jsx("input",{type:"number",step:"any",className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("address.coordinates.lat",{required:t("forms.validation.required"),valueAsNumber:!0})}),a.address?.coordinates?.lat&&e.jsx("span",{className:"text-red-400 text-xs",children:a.address.coordinates.lat.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:t("shops.longitude","Longitude")}),e.jsx("input",{type:"number",step:"any",className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("address.coordinates.lng",{required:t("forms.validation.required"),valueAsNumber:!0})}),a.address?.coordinates?.lng&&e.jsx("span",{className:"text-red-400 text-xs",children:a.address.coordinates.lng.message})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block mb-1",children:t("shops.openingHours")}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-1",children:t("shops.day","Day")}),e.jsx("th",{className:"p-1",children:t("shops.open","Open?")}),e.jsx("th",{className:"p-1",children:t("shops.openTime","Open Time")}),e.jsx("th",{className:"p-1",children:t("shops.closeTime","Close Time")})]})}),e.jsx("tbody",{children:Q.map(o=>e.jsxs("tr",{children:[e.jsx("td",{className:"p-1 capitalize",children:t(`shops.days.${o}`,o)}),e.jsx("td",{className:"p-1",children:e.jsx("input",{type:"checkbox",checked:v[o].isOpen,onChange:l=>w(r=>({...r,[o]:{...r[o],isOpen:l.target.checked}}))})}),e.jsx("td",{className:"p-1",children:e.jsx("input",{type:"time",className:"bg-[#1a2236] text-white rounded px-2 py-1",value:v[o].open,disabled:!v[o].isOpen,onChange:l=>w(r=>({...r,[o]:{...r[o],open:l.target.value}}))})}),e.jsx("td",{className:"p-1",children:e.jsx("input",{type:"time",className:"bg-[#1a2236] text-white rounded px-2 py-1",value:v[o].close,disabled:!v[o].isOpen,onChange:l=>w(r=>({...r,[o]:{...r[o],close:l.target.value}}))})})]},o))})]})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block mb-1",children:t("common.description")}),e.jsx("textarea",{className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",rows:2,...h("description")})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block mb-1",children:t("shops.shopPhoto","Shop Photo")}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{ref:q,type:"file",accept:"image/*",onChange:se,className:"flex-1 px-3 py-2 rounded bg-[#1a2236] text-white file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600"}),f&&e.jsx("button",{type:"button",onClick:te,className:"px-3 py-2 bg-red-500 hover:bg-red-600 rounded text-white text-sm",children:t("common.remove","Remove")})]}),f&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:f,alt:"Shop photo preview",className:"w-32 h-32 object-cover rounded border cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>B([f],0),title:"Click to preview",onError:o=>{console.error("Failed to load photo:",f),console.error("Error event:",o)},onLoad:()=>{console.log("Photo loaded successfully:",f)}})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block mb-1",children:t("shops.shopLogo","Shop Logo")}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{ref:R,type:"file",accept:"image/*",onChange:oe,className:"flex-1 px-3 py-2 rounded bg-[#1a2236] text-white file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600"}),b&&e.jsx("button",{type:"button",onClick:re,className:"px-3 py-2 bg-red-500 hover:bg-red-600 rounded text-white text-sm",children:t("common.remove","Remove")})]}),b&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:b,alt:"Shop logo preview",className:"w-32 h-32 object-cover rounded border cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>B([b],0),title:"Click to preview",onError:o=>{console.error("Failed to load logo:",b),console.error("Error event:",o)},onLoad:()=>{console.log("Logo loaded successfully:",b)}})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1",children:t("common.status")}),e.jsxs("select",{className:"w-full px-3 py-2 rounded bg-[#1a2236] text-white",...h("status",{required:!0}),children:[e.jsx("option",{value:"active",children:t("common.active")}),e.jsx("option",{value:"inactive",children:t("common.inactive")}),e.jsx("option",{value:"suspended",children:t("shops.suspended","Suspended")})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 rounded bg-gray-600 hover:bg-gray-700",onClick:_,children:t("common.cancel")}),e.jsx("button",{type:"submit",className:"px-4 py-2 rounded bg-blue-500 hover:bg-blue-600",disabled:m,children:m?p?t("common.saving","Saving..."):t("common.creating","Creating..."):t("common.save")})]})]})]}),e.jsx(ue,{open:!!O,images:O?.images||[],initialIndex:O?.initialIndex||0,onClose:()=>H(null)})]}):null}export{ye as S,K as g};
