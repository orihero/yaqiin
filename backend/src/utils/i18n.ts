const translations: Record<string, Record<string, string>> = {
  uz: {
    alreadyRegistered: 'âœ… Siz allaqachon roâ€˜yxatdan oâ€˜tgansiz!',
    openMiniApp: 'ğŸš€ Mini ilovani ochish:',
    openMiniAppBtn: 'ğŸŒ Mini ilova',
    welcome: 'ğŸ‘‹ Xush kelibsiz! Roâ€˜yxatdan oâ€˜tish uchun kontaktni ulashing.',
    shareContact: 'ğŸ“± Kontaktni ulashish',
    selectLanguage: 'ğŸŒ Iltimos, tilni tanlang:',
    shareLocation: 'ğŸ“ Iltimos, joylashuvingizni ulashing:',
    shareLocationBtn: 'ğŸ“ Joylashuvni ulashish',
    enterApartment: 'ğŸ¢ Iltimos, kvartira raqamingizni kiriting:',
    enterBlock: 'ğŸ¢ Iltimos, blok/binoni kiriting:',
    enterEntrance: 'ğŸšª Iltimos, kirish raqamini kiriting:',
    registrationComplete: 'ğŸ‰ Roâ€˜yxatdan oâ€˜tish muvaffaqiyatli yakunlandi! Rahmat.',
    shopArea: 'ğŸª Siz {shop} doâ€˜konining hududidasiz! Buyurtmalar shu doâ€˜kondan yetkaziladi. ğŸ˜Š',
    outOfService: 'ğŸš« Afsuski, sizning hududingizda xizmat koâ€˜rsatmaymiz. Yangiliklar uchun ijtimoiy tarmoqlarimizni kuzatib boring! ğŸ“±\nInstagram, Telegram, Facebook: @yaqiin',
    orderPacked: 'ğŸ“¦ Buyurtma qadoqlanmoqda!',
    orderPicked: 'ğŸšš Kuryer buyurtmani oldi!',
    orderRejected: 'âŒ Buyurtma rad etildi!',
    rejectReasonPrompt: 'âŒ Buyurtmani rad etish sababi:',
    reasonOutOfStock: 'Tovar yoâ€˜q',
    reasonClosed: 'Doâ€˜kon yopiq',
    reasonOutOfArea: 'Xizmat hududidan tashqarida',
    reasonOther: 'Boshqa sabab',
    enterCustomReason: 'Sababni yozing:',
    noFurtherAction: 'Boshqa amal yoâ€˜q.',
    orderNotFound: 'Buyurtma topilmadi',
    courierAccountConfigured: 'âœ… Hisob sozlandi!',
  },
  ru: {
    alreadyRegistered: 'âœ… Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹!',
    openMiniApp: 'ğŸš€ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ:',
    openMiniAppBtn: 'ğŸŒ ĞœĞ¸Ğ½Ğ¸-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ',
    welcome: 'ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ! ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ´ĞµĞ»Ğ¸Ñ‚ĞµÑÑŒ ÑĞ²Ğ¾Ğ¸Ğ¼ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ¼ Ğ´Ğ»Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸.',
    shareContact: 'ğŸ“± ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ¼',
    selectLanguage: 'ğŸŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº:',
    shareLocation: 'ğŸ“ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ´ĞµĞ»Ğ¸Ñ‚ĞµÑÑŒ ÑĞ²Ğ¾Ğ¸Ğ¼ Ğ¼ĞµÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼:',
    shareLocationBtn: 'ğŸ“ ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ Ğ¼ĞµÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼',
    enterApartment: 'ğŸ¢ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ ĞºĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ñ‹:',
    enterBlock: 'ğŸ¢ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ±Ğ»Ğ¾Ğº/Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ:',
    enterEntrance: 'ğŸšª ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ğ¾Ğ´ÑŠĞµĞ·Ğ´Ğ°:',
    registrationComplete: 'ğŸ‰ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°! Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾.',
    shopArea: 'ğŸª Ğ’Ñ‹ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ² Ğ·Ğ¾Ğ½Ğµ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ° {shop}! Ğ’Ğ°ÑˆĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑÑ‚ÑŒÑÑ Ğ¸Ğ· ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°. ğŸ˜Š',
    outOfService: 'ğŸš« Ğš ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, Ğ¼Ñ‹ Ğ½Ğµ Ğ¾Ğ±ÑĞ»ÑƒĞ¶Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ğ°Ñˆ Ñ€Ğ°Ğ¹Ğ¾Ğ½. Ğ¡Ğ»ĞµĞ´Ğ¸Ñ‚Ğµ Ğ·Ğ° Ğ½Ğ°ÑˆĞ¸Ğ¼Ğ¸ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ÑĞ¼Ğ¸ Ğ² ÑĞ¾Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑĞµÑ‚ÑÑ…! ğŸ“±\nInstagram, Telegram, Facebook: @yaqiin',
    orderPacked: 'ğŸ“¦ Ğ—Ğ°ĞºĞ°Ğ· ÑƒĞ¿Ğ°ĞºĞ¾Ğ²Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ!',
    orderPicked: 'ğŸšš ĞšÑƒÑ€ÑŒĞµÑ€ Ğ·Ğ°Ğ±Ñ€Ğ°Ğ» Ğ·Ğ°ĞºĞ°Ğ·!',
    orderRejected: 'âŒ Ğ—Ğ°ĞºĞ°Ğ· Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½Ñ‘Ğ½!',
    rejectReasonPrompt: 'âŒ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ°:',
    reasonOutOfStock: 'ĞĞµÑ‚ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°',
    reasonClosed: 'ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚',
    reasonOutOfArea: 'Ğ’Ğ½Ğµ Ğ·Ğ¾Ğ½Ñ‹ Ğ¾Ğ±ÑĞ»ÑƒĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ',
    reasonOther: 'Ğ”Ñ€ÑƒĞ³Ğ°Ñ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°',
    enterCustomReason: 'ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ:',
    noFurtherAction: 'ĞĞµÑ‚ Ğ´Ğ°Ğ»ÑŒĞ½ĞµĞ¹ÑˆĞ¸Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹.',
    orderNotFound: 'Ğ—Ğ°ĞºĞ°Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½',
    courierAccountConfigured: 'âœ… ĞĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½!',
  },
  en: {
    alreadyRegistered: 'âœ… You are already registered!',
    openMiniApp: 'ğŸš€ Open the Mini App:',
    openMiniAppBtn: 'ğŸŒ Open Mini App',
    welcome: 'ğŸ‘‹ Welcome! Please share your contact to register.',
    shareContact: 'ğŸ“± Share Contact',
    selectLanguage: 'ğŸŒ Please select your language:',
    shareLocation: 'ğŸ“ Please share your location:',
    shareLocationBtn: 'ğŸ“ Share Location',
    enterApartment: 'ğŸ¢ Please enter your apartment number:',
    enterBlock: 'ğŸ¢ Please enter your block/building:',
    enterEntrance: 'ğŸšª Please enter your entrance number:',
    registrationComplete: 'ğŸ‰ Registration complete! Thank you.',
    shopArea: 'ğŸª You are in the delivery area of {shop}! Orders will be delivered from this shop. ğŸ˜Š',
    outOfService: 'ğŸš« Unfortunately, we do not serve your area yet. Follow us on social media for updates! ğŸ“±\nInstagram, Telegram, Facebook: @yaqiin',
    orderPacked: 'ğŸ“¦ Order is being packed!',
    orderPicked: 'ğŸšš Courier picked up the order!',
    orderRejected: 'âŒ Order has been rejected!',
    rejectReasonPrompt: 'âŒ Reason for order rejection:',
    reasonOutOfStock: 'Out of stock',
    reasonClosed: 'Shop closed',
    reasonOutOfArea: 'Out of service area',
    reasonOther: 'Other reason',
    enterCustomReason: 'Please enter the reason:',
    noFurtherAction: 'No further action available.',
    orderNotFound: 'Order not found',
    courierAccountConfigured: 'âœ… Account configured!',
  },
};

// Courier bot translations
Object.assign(translations.uz, {
  courierWelcome: 'ğŸ‘‹ Xush kelibsiz! Bu bot orqali siz buyurtmalarni boshqarishingiz mumkin. Operator yoki administrator yuborgan kodni kiriting.',
  courierAskCode: 'Iltimos, operator yoki administrator yuborgan kodni kiriting.',
  courierInvalidCode: 'âŒ Kod notoâ€˜gâ€˜ri. Iltimos, toâ€˜gâ€˜ri kod kiriting.',
  courierAskLanguage: 'ğŸŒ Iltimos, tilni tanlang:',
  courierConfiguredCourier: 'ğŸšš Sizning hisobingiz kuryer sifatida sozlandi. Endi buyurtmalarni qabul qilishingiz mumkin!',
  courierConfiguredShopOwner: 'ğŸª Sizning hisobingiz doâ€˜kon egasi sifatida sozlandi. Endi buyurtmalarni boshqarishingiz mumkin!',
  courierSuccess: 'âœ… Xush kelibsiz, {name}! Tilni tanlang:',
  courierOrderPicked: 'ğŸšš Buyurtma kuryerda!',
  courierOrderDelivered: 'ğŸ“¦ Buyurtma yetkazib berildi!',
  courierOrderRejected: 'âŒ Buyurtma rad etildi!',
  courierRejectReasonPrompt: 'âŒ Buyurtmani rad etish sababi:',
  courierReasonNoContact: 'Mijoz bilan bogâ€˜lanib boâ€˜lmadi',
  courierReasonNoAddress: 'Manzil topilmadi',
  courierReasonOther: 'Boshqa sabab',
  courierEnterCustomReason: 'Sababni yozing:',
  courierNoFurtherAction: 'Boshqa amal yoâ€˜q.',
  courierOrderNotFound: 'Buyurtma topilmadi',
});
Object.assign(translations.ru, {
  courierWelcome: 'ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ! Ğ¡ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ° Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼Ğ¸. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ´, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ Ğ¸Ğ»Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€.',
  courierAskCode: 'ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ´, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ Ğ¸Ğ»Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼.',
  courierInvalidCode: 'âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´.',
  courierAskLanguage: 'ğŸŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº:',
  courierConfiguredCourier: 'ğŸšš Ğ’Ğ°ÑˆĞ° ÑƒÑ‡ĞµÑ‚Ğ½Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ° ĞºĞ°Ğº ĞºÑƒÑ€ÑŒĞµÑ€. Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹!',
  courierConfiguredShopOwner: 'ğŸª Ğ’Ğ°ÑˆĞ° ÑƒÑ‡ĞµÑ‚Ğ½Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ° ĞºĞ°Ğº Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ† Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°. Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼Ğ¸!',
  courierSuccess: 'âœ… Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ, {name}! ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº:',
  courierOrderPicked: 'ğŸšš Ğ—Ğ°ĞºĞ°Ğ· Ñƒ ĞºÑƒÑ€ÑŒĞµÑ€Ğ°!',
  courierOrderDelivered: 'ğŸ“¦ Ğ—Ğ°ĞºĞ°Ğ· Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½!',
  courierOrderRejected: 'âŒ Ğ—Ğ°ĞºĞ°Ğ· Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½Ñ‘Ğ½!',
  courierRejectReasonPrompt: 'âŒ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ°:',
  courierReasonNoContact: 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ²ÑĞ·Ğ°Ñ‚ÑŒÑÑ Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ¼',
  courierReasonNoAddress: 'ĞĞ´Ñ€ĞµÑ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½',
  courierReasonOther: 'Ğ”Ñ€ÑƒĞ³Ğ°Ñ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°',
  courierEnterCustomReason: 'ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ:',
  courierNoFurtherAction: 'ĞĞµÑ‚ Ğ´Ğ°Ğ»ÑŒĞ½ĞµĞ¹ÑˆĞ¸Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹.',
  courierOrderNotFound: 'Ğ—Ğ°ĞºĞ°Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½',
});
Object.assign(translations.en, {
  courierWelcome: 'ğŸ‘‹ Welcome! You can manage orders with this bot. Please enter the code sent by the operator or administrator.',
  courierAskCode: 'Please enter the code sent by the operator or administrator.',
  courierInvalidCode: 'âŒ Invalid code. Please enter the correct code.',
  courierAskLanguage: 'ğŸŒ Please select your language:',
  courierConfiguredCourier: 'ğŸšš Your account is set up as a courier. You can now accept orders!',
  courierConfiguredShopOwner: 'ğŸª Your account is set up as a shop owner. You can now manage orders!',
  courierSuccess: 'âœ… Welcome, {name}! Please select your language:',
  courierOrderPicked: 'ğŸšš Order is with the courier!',
  courierOrderDelivered: 'ğŸ“¦ Order delivered!',
  courierOrderRejected: 'âŒ Order has been rejected!',
  courierRejectReasonPrompt: 'âŒ Reason for order rejection:',
  courierReasonNoContact: 'Could not contact customer',
  courierReasonNoAddress: 'Address not found',
  courierReasonOther: 'Other reason',
  courierEnterCustomReason: 'Please enter the reason:',
  courierNoFurtherAction: 'No further action available.',
  courierOrderNotFound: 'Order not found',
});

function getLang(ctx: any, fallback = 'en') {
  // Try to extract language from registration state, session, or fallback
  if (ctx) {
    const telegramId = ctx.from && ctx.from.id ? String(ctx.from.id) : undefined;
    if (telegramId && ctx.registrationState && ctx.registrationState.get) {
      const state = ctx.registrationState.get(telegramId);
      if (state && state.language) return state.language;
    }
    if (ctx.sessionUserMap && ctx.sessionUserMap.get) {
      const user = ctx.sessionUserMap.get(ctx);
      if (user && user.preferences && user.preferences.language) return user.preferences.language;
    }
    if (ctx.from && ctx.from.language_code) {
      // Telegram language code
      const code = ctx.from.language_code.split('-')[0];
      if (translations[code]) return code;
    }
  }
  return fallback;
}

function t(ctx: any, key: string, params?: Record<string, string | number>) {
  const lang = getLang(ctx);
  let str = translations[lang]?.[key] || translations['en'][key] || key;
  if (params) {
    Object.entries(params).forEach(([k, v]) => {
      str = str.replace(`{${k}}`, String(v));
    });
  }
  return str;
}

export { t, getLang, translations }; 